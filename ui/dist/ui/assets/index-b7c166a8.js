import{cp as he,cq as s,d1 as ye,dt as we,d3 as oe,d0 as fe,cu as u,cU as Ce,cx as p,cF as V,cA as o,cB as r,cJ as i,cz as l,cK as d,cv as ke,cy as S,dg as Ke,cZ as $,cr as te,ct as Ze,cC as ae,cD as le,cN as J,cE as K,cH as Qe,du as We,dp as Xe,dq as et,dr as tt,cT as at,ej as be,e8 as lt,e9 as ot,dh as nt,cR as st}from"./index-1a322249.js";const it={class:"single-line"},rt={class:"h-full",style:{padding:"24px 0"}},ut=he({__name:"ChatRecordDrawer",props:{application:{},chatId:{},currentAbstract:{},next:{},pre:{},pre_disable:{type:Boolean},next_disable:{type:Boolean}},emits:["update:chatId","update:currentAbstract","refresh"],setup(ne,{expose:se,emit:q}){const j=s(),{log:Z}=ye(),B=ne,M=q,g=we(),{params:{id:P}}=g,L=s(!1),A=s(!1),v=s([]),f=oe({current_page:1,page_size:20,total:0});function U(){v.value=[],f.total=0,f.current_page=1}function Y(){return Z.asyncChatRecordLog(P,B.chatId,f,L).then(n=>{f.total=n.data.total;const b=n.data.records;v.value=[...b,...v.value].sort((w,C)=>w.create_time.localeCompare(C.create_time)),f.current_page===1&&Ke(()=>{j.value.setScrollBottom()})})}fe(()=>B.chatId,()=>{v.value=[],f.total=0,f.current_page=1,B.chatId&&Y()}),fe(A,n=>{n||(M("update:chatId",""),M("update:currentAbstract",""),M("refresh"))});function R(n){if(B.chatId!=="new"&&n.scrollTop===0&&f.total>v.value.length){const b=n.dialogScrollbar.offsetHeight;f.current_page+=1,Y().then(()=>{n.scrollDiv.setScrollTop(n.dialogScrollbar.offsetHeight-b)})}}return se({open:()=>{A.value=!0}}),(n,b)=>{const w=u("AiChat"),C=u("el-button"),m=u("el-drawer"),O=Ce("loading");return p(),V(m,{modelValue:A.value,"onUpdate:modelValue":b[0]||(b[0]=T=>A.value=T),size:"60%",onClose:U,class:"chat-record-drawer"},{header:o(()=>[r("h4",it,i(n.currentAbstract),1)]),footer:o(()=>[r("div",null,[l(C,{onClick:n.pre,disabled:n.pre_disable||L.value},{default:o(()=>[d(i(n.$t("views.log.buttons.prev")),1)]),_:1},8,["onClick","disabled"]),l(C,{onClick:n.next,disabled:n.next_disable||L.value},{default:o(()=>[d(i(n.$t("views.log.buttons.next")),1)]),_:1},8,["onClick","disabled"])])]),default:o(()=>[ke((p(),S("div",rt,[l(w,{ref_key:"AiChatRef",ref:j,"application-details":n.application,type:"log",record:v.value,onScroll:R},null,8,["application-details","record"])])),[[O,f.current_page===1&&L.value]])]),_:1},8,["modelValue"])}}});const dt={class:"p-24"},ct={class:"mb-16"},pt={style:{display:"flex","align-items":"center"},class:"float-right"},mt={class:"filter"},vt={class:"form-item mb-16"},_t={class:"form-item mb-16"},gt={class:"text-right"},ft={key:0,class:"mr-8"},bt={key:1,class:"mr-8"},ht={key:0},yt={key:1,class:"ml-8"},wt={class:"dialog-footer",style:{"margin-top":"16px"}},Ct={class:"flex align-center"},kt={class:"dialog-footer"},Dt=he({__name:"index",emits:["refresh"],setup(ne,{emit:se}){const{application:q,log:j,document:Z,user:B}=ye(),M=we(),{params:{id:g}}=M,P=s(),L=[{value:7,label:$("views.applicationOverview.monitor.pastDayOptions.past7Days")},{value:30,label:$("views.applicationOverview.monitor.pastDayOptions.past30Days")},{value:90,label:$("views.applicationOverview.monitor.pastDayOptions.past90Days")},{value:183,label:$("views.applicationOverview.monitor.pastDayOptions.past183Days")},{value:"other",label:$("views.applicationOverview.monitor.pastDayOptions.other")}],A=s(""),v=s({start_time:"",end_time:""}),f=s(),U=s([]),Y=s(),R=s(!1),F=s(!1),n=oe({current_page:1,page_size:20,total:0}),b=s(!1),w=s(!1),C=s(180),m=s([]),O=te(()=>m.value.map((e,t)=>({[e.id]:t})).reduce((e,t)=>({...e,...t}),{})),T=s(7),x=s(""),H=s(null),_=s(""),I=s(""),G=s(!1),De={min_star:0,min_trample:0,comparer:"and"},k=s({min_star:0,min_trample:0,comparer:"and"}),c=s({dataset_id:"",document_id:""}),Ve=oe({dataset_id:[{required:!0,message:$("views.log.selectDatasetPlaceholder"),trigger:"change"}],document_id:[{required:!0,message:$("views.log.documentPlaceholder"),trigger:"change"}]}),ie=s(!1),Q=s([]);function re(e){e==="clear"&&(k.value=at.cloneDeep(De)),D(),G.value=!1}const $e=()=>{let e=O.value[_.value]+1;if(e>=m.value.length){if(e+(n.current_page-1)*n.page_size>=n.total-1)return;n.current_page=n.current_page+1,D().then(()=>{e=0,_.value=m.value[e].id,I.value=m.value[e].abstract})}else _.value=m.value[e].id,I.value=m.value[e].abstract},Se=te(()=>O.value[_.value]-1<0&&n.current_page<=1),Ae=te(()=>{let e=O.value[_.value]+1;return e>=m.value.length&&e+(n.current_page-1)*n.page_size>=n.total-1}),Re=()=>{let e=O.value[_.value]-1;if(e<0){if(n.current_page<=1)return;n.current_page=n.current_page-1,D().then(()=>{e=n.page_size-1,_.value=m.value[e].id,I.value=m.value[e].abstract})}else _.value=m.value[e].id,I.value=m.value[e].abstract};function Ie(e,t){t&&t.type==="selection"||(_.value=e.id,I.value=e.abstract,Y.value.open())}const ze=({row:e})=>_.value===(e==null?void 0:e.id)?"highlight":"",Le=e=>{U.value=e};function D(){let e={start_time:v.value.start_time,end_time:v.value.end_time,...k.value};return x.value&&(e={...e,abstract:x.value}),j.asyncGetChatLog(g,n,e,R).then(t=>{var h;m.value=t.data.records,_.value&&(_.value=(h=m.value[0])==null?void 0:h.id),n.total=t.data.total})}function ue(e=!1){q.asyncGetApplicationDetail(g,e?R:void 0).then(t=>{H.value=t.data,C.value=t.data.clean_time})}const Ue=()=>{const e=[];if(U.value.map(t=>{t&&e.push(t.id)}),H.value){let t={start_time:v.value.start_time,end_time:v.value.end_time,...k.value};x.value&&(t={...t,abstract:x.value}),be.exportChatLog(H.value.id,H.value.name,t,{select_ids:e},R)}};function Oe(){D()}function Te(e){v.value.start_time=e[0],v.value.end_time=e[1],D()}function de(e){e!=="other"&&(v.value.start_time=lt(e),v.value.end_time=ot,D())}function xe(){const e={clean_time:C.value};q.asyncPutApplication(g,e,R).then(()=>{nt($("common.saveSuccess")),b.value=!1,ue(!0)}).catch(()=>{b.value=!1})}function qe(e){localStorage.setItem(g+"chat_dataset_id",e),c.value.document_id="",ce(e)}function Be(e){localStorage.setItem(g+"chat_document_id",e)}const W=s([]);function Me(){q.asyncGetApplicationDataset(g,F).then(e=>{W.value=e.data,localStorage.getItem(g+"chat_dataset_id")&&(c.value.dataset_id=localStorage.getItem(g+"chat_dataset_id"),W.value.find(t=>t.id===c.value.dataset_id)?ce(c.value.dataset_id):(c.value.dataset_id="",c.value.document_id=""))})}const Pe=async e=>{if(!e)return;const t=[];U.value.map(h=>{h&&t.push(h.id)}),await e.validate(h=>{if(h){const N={document_id:c.value.document_id,dataset_id:c.value.dataset_id,chat_ids:t};be.postChatRecordLog(g,c.value.dataset_id,N,F).then(pe=>{var E;(E=f.value)==null||E.clearSelection(),w.value=!1})}})};function ce(e){Z.asyncGetAllDocument(e,F).then(t=>{Q.value=t.data,localStorage.getItem(g+"chat_document_id")&&(c.value.document_id=localStorage.getItem(g+"chat_document_id")),Q.value.find(h=>h.id===c.value.document_id)||(c.value.document_id="")})}function Ye(){var e;Me(),(e=P.value)==null||e.clearValidate(),w.value=!0}return Ze(()=>{de(T.value),ue()}),(e,t)=>{const h=u("el-option"),N=u("el-select"),pe=u("el-date-picker"),E=u("el-input"),y=u("el-button"),z=u("el-table-column"),Fe=u("Filter"),He=u("el-icon"),X=u("el-input-number"),Ne=u("el-popover"),me=u("AppIcon"),je=u("app-table"),ve=u("el-dialog"),ee=u("AppAvatar"),_e=u("el-form-item"),Ge=u("el-form"),Ee=u("LayoutContainer"),Je=Ce("loading");return p(),V(Ee,{header:e.$t("views.log.title")},{default:o(()=>[r("div",dt,[r("div",ct,[l(N,{modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=a=>T.value=a),class:"mr-12",onChange:de,style:{width:"180px"}},{default:o(()=>[(p(),S(ae,null,le(L,a=>l(h,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),T.value==="other"?(p(),V(pe,{key:0,modelValue:A.value,"onUpdate:modelValue":t[1]||(t[1]=a=>A.value=a),type:"daterange","start-placeholder":e.$t("views.applicationOverview.monitor.startDatePlaceholder"),"end-placeholder":e.$t("views.applicationOverview.monitor.endDatePlaceholder"),format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:Te},null,8,["modelValue","start-placeholder","end-placeholder"])):J("",!0),l(E,{modelValue:x.value,"onUpdate:modelValue":t[2]||(t[2]=a=>x.value=a),onChange:D,placeholder:e.$t("common.search"),"prefix-icon":"Search",class:"w-240",clearable:""},null,8,["modelValue","placeholder"]),r("div",pt,[l(y,{onClick:t[3]||(t[3]=a=>b.value=!0)},{default:o(()=>[d(i(e.$t("views.log.buttons.clearStrategy")),1)]),_:1}),l(y,{onClick:Ue},{default:o(()=>[d(i(e.$t("common.export")),1)]),_:1}),l(y,{onClick:Ye,disabled:U.value.length===0},{default:o(()=>[d(i(e.$t("views.log.addToDataset")),1)]),_:1},8,["disabled"])])]),ke((p(),V(je,{data:m.value,"pagination-config":n,onSizeChange:D,onChangePage:D,onRowClick:Ie,"row-class-name":ze,onSelectionChange:Le,class:"log-table",ref_key:"multipleTableRef",ref:f},{default:o(()=>[l(z,{type:"selection",width:"55"}),l(z,{prop:"abstract",label:e.$t("views.log.table.abstract"),"show-overflow-tooltip":""},null,8,["label"]),l(z,{prop:"chat_record_count",label:e.$t("views.log.table.chat_record_count"),align:"right"},null,8,["label"]),l(z,{prop:"star_num",align:"right"},{header:o(()=>[r("div",null,[r("span",null,i(e.$t("views.log.table.feedback.label")),1),l(Ne,{width:200,trigger:"click",visible:G.value},{reference:o(()=>[l(y,{style:{"margin-top":"-2px"},type:k.value.min_star||k.value.min_trample?"primary":"",link:"",onClick:t[4]||(t[4]=a=>G.value=!G.value)},{default:o(()=>[l(He,null,{default:o(()=>[l(Fe)]),_:1})]),_:1},8,["type"])]),default:o(()=>[r("div",mt,[r("div",vt,[r("div",{onClick:t[6]||(t[6]=K(()=>{},["stop"]))},[d(i(e.$t("views.log.table.feedback.star"))+" >= ",1),l(X,{modelValue:k.value.min_star,"onUpdate:modelValue":t[5]||(t[5]=a=>k.value.min_star=a),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])]),r("div",_t,[r("div",{onClick:t[8]||(t[8]=K(()=>{},["stop"]))},[d(i(e.$t("views.log.table.feedback.trample"))+" >= ",1),l(X,{modelValue:k.value.min_trample,"onUpdate:modelValue":t[7]||(t[7]=a=>k.value.min_trample=a),min:0,step:1,"value-on-clear":0,"controls-position":"right",style:{width:"80px"},size:"small","step-strictly":""},null,8,["modelValue"])])])]),r("div",gt,[l(y,{size:"small",onClick:t[9]||(t[9]=a=>re("clear"))},{default:o(()=>[d(i(e.$t("common.clear")),1)]),_:1}),l(y,{type:"primary",onClick:re,size:"small"},{default:o(()=>[d(i(e.$t("common.confirm")),1)]),_:1})])]),_:1},8,["visible"])])]),default:o(({row:a})=>[!a.trample_num&&!a.star_num?(p(),S("span",ft," - ")):(p(),S("span",bt,[a.star_num?(p(),S("span",ht,[l(me,{iconName:"app-like-color"}),d(" "+i(a.star_num),1)])):J("",!0),a.trample_num?(p(),S("span",yt,[l(me,{iconName:"app-oppose-color"}),d(" "+i(a.trample_num),1)])):J("",!0)]))]),_:1}),l(z,{prop:"mark_sum",label:e.$t("views.log.table.mark"),align:"right"},null,8,["label"]),l(z,{prop:"asker",label:e.$t("views.log.table.user")},{default:o(({row:a})=>{var ge;return[d(i((ge=a.asker)==null?void 0:ge.user_name),1)]}),_:1},8,["label"]),l(z,{label:e.$t("views.log.table.recenTimes"),width:"180"},{default:o(({row:a})=>[d(i(Qe(We)(a.update_time)),1)]),_:1},8,["label"])]),_:1},8,["data","pagination-config"])),[[Je,R.value]])]),l(ut,{next:$e,pre:Re,ref_key:"ChatRecordRef",ref:Y,chatId:_.value,"onUpdate:chatId":t[10]||(t[10]=a=>_.value=a),currentAbstract:I.value,"onUpdate:currentAbstract":t[11]||(t[11]=a=>I.value=a),application:H.value,pre_disable:Se.value,next_disable:Ae.value,onRefresh:Oe},null,8,["chatId","currentAbstract","application","pre_disable","next_disable"]),l(ve,{title:e.$t("views.log.buttons.clearStrategy"),modelValue:b.value,"onUpdate:modelValue":t[14]||(t[14]=a=>b.value=a),width:"25%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("div",wt,[l(y,{onClick:t[13]||(t[13]=a=>b.value=!1)},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:xe},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1})])]),default:o(()=>[r("span",null,i(e.$t("common.delete")),1),l(X,{modelValue:C.value,"onUpdate:modelValue":t[12]||(t[12]=a=>C.value=a),"controls-position":"right",min:1,max:1e5,"value-on-clear":0,"step-strictly":"",style:{width:"110px","margin-left":"8px","margin-right":"8px"}},null,8,["modelValue"]),r("span",null,i(e.$t("views.log.daysText")),1)]),_:1},8,["title","modelValue"]),l(ve,{title:e.$t("views.log.addToDataset"),modelValue:w.value,"onUpdate:modelValue":t[20]||(t[20]=a=>w.value=a),width:"50%","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:o(()=>[r("span",kt,[l(y,{onClick:t[18]||(t[18]=K(a=>w.value=!1,["prevent"]))},{default:o(()=>[d(i(e.$t("common.cancel")),1)]),_:1}),l(y,{type:"primary",onClick:t[19]||(t[19]=a=>Pe(P.value)),loading:F.value},{default:o(()=>[d(i(e.$t("common.save")),1)]),_:1},8,["loading"])])]),default:o(()=>[l(Ge,{ref_key:"formRef",ref:P,model:c.value,"label-position":"top","require-asterisk-position":"right",rules:Ve,onSubmit:t[17]||(t[17]=K(()=>{},["prevent"]))},{default:o(()=>[l(_e,{label:e.$t("views.log.selectDataset"),prop:"dataset_id"},{default:o(()=>[l(N,{modelValue:c.value.dataset_id,"onUpdate:modelValue":t[15]||(t[15]=a=>c.value.dataset_id=a),filterable:"",placeholder:e.$t("views.log.selectDatasetPlaceholder"),loading:ie.value,onChange:qe},{default:o(()=>[(p(!0),S(ae,null,le(W.value,a=>(p(),V(h,{key:a.id,label:a.name,value:a.id},{default:o(()=>[r("span",Ct,[!a.dataset_id&&a.type==="1"?(p(),V(ee,{key:0,class:"mr-12 avatar-purple",shape:"square",size:24},{default:o(()=>t[21]||(t[21]=[r("img",{src:Xe,style:{width:"58%"},alt:""},null,-1)])),_:1})):!a.dataset_id&&a.type==="2"?(p(),V(ee,{key:1,class:"mr-12 avatar-purple",shape:"square",size:24,style:{background:"none"}},{default:o(()=>t[22]||(t[22]=[r("img",{src:et,style:{width:"100%"},alt:""},null,-1)])),_:1})):!a.dataset_id&&a.type==="0"?(p(),V(ee,{key:2,class:"mr-12 avatar-blue",shape:"square",size:24},{default:o(()=>t[23]||(t[23]=[r("img",{src:tt,style:{width:"58%"},alt:""},null,-1)])),_:1})):J("",!0),d(" "+i(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"]),l(_e,{label:e.$t("views.log.saveToDocument"),prop:"document_id"},{default:o(()=>[l(N,{modelValue:c.value.document_id,"onUpdate:modelValue":t[16]||(t[16]=a=>c.value.document_id=a),filterable:"",placeholder:e.$t("views.log.documentPlaceholder"),loading:ie.value,onChange:Be},{default:o(()=>[(p(!0),S(ae,null,le(Q.value,a=>(p(),V(h,{key:a.id,label:a.name,value:a.id},{default:o(()=>[d(i(a.name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])]),_:1},8,["header"])}}});const $t=st(Dt,[["__scopeId","data-v-813f76a8"]]);export{$t as default};
